<div class="relative bg-blue-500 md:pt-32 pb-32 pt-12">
    <div class="px-4 md:px-10 mx-auto w-full">
        <div>
            <!-- Card stats -->
            <div class="flex flex-wrap">
                <div class="w-full lg:w-6/12 xl:w-3/12 px-4">
                    <div class="relative flex flex-col min-w-0 break-words bg-white rounded mb-6 xl:mb-0 shadow-lg">
                        <div class="flex-auto p-4">
                            <div class="flex flex-wrap">
                                <div class="relative w-full pr-4 max-w-full flex-grow flex-1">
                                    <h5 class="text-gray-500 uppercase font-bold text-xs">
                                        Traffic
                                    </h5>
                                    <span class="font-semibold text-xl text-gray-800">
                                        350,897
                                    </span>
                                </div>
                                <div class="relative w-auto pl-4 flex-initial">
                                    <div class="text-white p-3 text-center inline-flex items-center justify-center w-12 h-12 shadow-lg rounded-full bg-red-500">
                                        <i class="far fa-chart-bar"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full lg:w-6/12 xl:w-3/12 px-4">
                    <div class="relative flex flex-col min-w-0 break-words bg-white rounded mb-6 xl:mb-0 shadow-lg">
                        <div class="flex-auto p-4">
                            <div class="flex flex-wrap">
                                <div class="relative w-full pr-4 max-w-full flex-grow flex-1">
                                    <h5 class="text-gray-500 uppercase font-bold text-xs">
                                        New users
                                    </h5>
                                    <span class="font-semibold text-xl text-gray-800">
                                        2,356
                                    </span>
                                </div>
                                <div class="relative w-auto pl-4 flex-initial">
                                    <div class="text-white p-3 text-center inline-flex items-center justify-center w-12 h-12 shadow-lg rounded-full bg-orange-500">
                                        <i class="fas fa-chart-pie"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full lg:w-6/12 xl:w-3/12 px-4">
                    <div class="relative flex flex-col min-w-0 break-words bg-white rounded mb-6 xl:mb-0 shadow-lg">
                        <div class="flex-auto p-4">
                            <div class="flex flex-wrap">
                                <div class="relative w-full pr-4 max-w-full flex-grow flex-1">
                                    <h5 class="text-gray-500 uppercase font-bold text-xs">
                                        Sales
                                    </h5>
                                    <span class="font-semibold text-xl text-gray-800">
                                        924
                                    </span>
                                </div>
                                <div class="relative w-auto pl-4 flex-initial">
                                    <div class="text-white p-3 text-center inline-flex items-center justify-center w-12 h-12 shadow-lg rounded-full bg-pink-500">
                                        <i class="fas fa-users"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full lg:w-6/12 xl:w-3/12 px-4">
                    <div class="relative flex flex-col min-w-0 break-words bg-white rounded mb-6 xl:mb-0 shadow-lg">
                        <div class="flex-auto p-4">
                            <div class="flex flex-wrap">
                                <div class="relative w-full pr-4 max-w-full flex-grow flex-1">
                                    <h5 class="text-gray-500 uppercase font-bold text-xs">
                                        Performance
                                    </h5>
                                    <span class="font-semibold text-xl text-gray-800">
                                        49,65%
                                    </span>
                                </div>
                                <div class="relative w-auto pl-4 flex-initial">
                                    <div class="text-white p-3 text-center inline-flex items-center justify-center w-12 h-12 shadow-lg rounded-full bg-blue-500">
                                        <i class="fas fa-percent"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="px-4 md:px-10 mx-auto w-full -m-24">
    <div class="flex flex-wrap mt-4">
        <div class="w-full mb-12 px-4">
            <div class="relative flex flex-col min-w-0 break-words w-full mb-6 shadow-lg rounded bg-white">
                <div class="rounded-t mb-0 px-4 py-3 border-0">
                    <div class="flex flex-wrap items-center">
                        <div class="relative w-full px-4 max-w-full flex-grow flex-1">
                            <h3 class="font-semibold text-lg text-gray-800">
                                Order History List
                            </h3>
                        </div>
                    </div>
                </div>
                <div class="block w-full overflow-x-scroll">
                    <!-- Projects table -->
                    <table class="items-center w-full bg-transparent border-collapse datatables">
                        <thead>
                            <tr>
                                <th class="px-6 align-middle border border-solid py-3 text-xs uppercase border-l-0 border-r-0 whitespace-no-wrap font-semibold text-left bg-gray-100 text-gray-600 border-gray-200">
                                    Nama
                                </th>
                                <th class="px-6 align-middle border border-solid py-3 text-xs uppercase border-l-0 border-r-0 whitespace-no-wrap font-semibold text-left bg-gray-100 text-gray-600 border-gray-200">
                                    Departemen
                                </th>
                                <th class="px-6 align-middle border border-solid py-3 text-xs uppercase border-l-0 border-r-0 whitespace-no-wrap font-semibold text-left bg-gray-100 text-gray-600 border-gray-200">
                                    Proyek
                                </th>
                                <th class="px-6 align-middle border border-solid py-3 text-xs uppercase border-l-0 border-r-0 whitespace-no-wrap font-semibold text-left bg-gray-100 text-gray-600 border-gray-200">
                                    Tipe Perjalanan
                                </th>
                                <th class="px-6 align-middle border border-solid py-3 text-xs uppercase border-l-0 border-r-0 whitespace-no-wrap font-semibold text-left bg-gray-100 text-gray-600 border-gray-200">
                                    Alamat Asal
                                </th>
                                <th class="px-6 align-middle border border-solid py-3 text-xs uppercase border-l-0 border-r-0 whitespace-no-wrap font-semibold text-left bg-gray-100 text-gray-600 border-gray-200">
                                    Alamat Tujuan
                                </th>
                                <th class="px-6 align-middle border border-solid py-3 text-xs uppercase border-l-0 border-r-0 whitespace-no-wrap font-semibold text-left bg-gray-100 text-gray-600 border-gray-200">
                                    Tanggal Berangkat
                                </th>
                                <th class="px-6 align-middle border border-solid py-3 text-xs uppercase border-l-0 border-r-0 whitespace-no-wrap font-semibold text-left bg-gray-100 text-gray-600 border-gray-200">
                                    Status
                                </th>
                                <th class="px-6 align-middle border border-solid py-3 text-xs uppercase border-l-0 border-r-0 whitespace-no-wrap font-semibold text-left bg-gray-100 text-gray-600 border-gray-200"></th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<script type="text/javascript">
    /* Make dynamic date appear */
    (function() {
        if (document.getElementById("get-current-year")) {
            document.getElementById(
                "get-current-year"
            ).innerHTML = new Date().getFullYear();
        }
    })();
    /* Sidebar - Side navigation menu on mobile/responsive mode */
    function toggleNavbar(collapseID) {
        document.getElementById(collapseID).classList.toggle("hidden");
        document.getElementById(collapseID).classList.toggle("bg-white");
        document.getElementById(collapseID).classList.toggle("m-2");
        document.getElementById(collapseID).classList.toggle("py-3");
        document.getElementById(collapseID).classList.toggle("px-6");
    }
    /* Function for dropdowns */
    function openDropdown(event, dropdownID) {
        let element = event.target;
        while (element.nodeName !== "A") {
            element = element.parentNode;
        }
        Popper.createPopper(element, document.getElementById(dropdownID), {
            placement: "bottom-start",
        });
        document.getElementById(dropdownID).classList.toggle("hidden");
        document.getElementById(dropdownID).classList.toggle("block");
    }
    load_onprogress_order();

    function load_onprogress_order() {
        db.collection("Travel")
            .onSnapshot(function(querySnapshot) {
                var json_all = [];
                querySnapshot.forEach(function(doc) {
                    json_all[doc.id] = doc.data();
                });
                gabung_data('travel', json_all);
            });
        db.collection("Request").orderBy("Tanggal_Berangkat", "desc")
            .onSnapshot(function(querySnapshot) {
                var json_all = [];
                querySnapshot.forEach(function(doc) {
                    json_all[doc.id] = doc.data();
                });
                gabung_data('request', json_all);
            });
        db.collection("Users")
            .onSnapshot(function(querySnapshot) {
                var json_all = [];
                querySnapshot.forEach(function(doc) {
                    json_all[doc.id] = doc.data()
                });
                gabung_data('users', json_all);
            });
        db.collection("Car")
            .onSnapshot(function(querySnapshot) {
                var json_all = [];
                querySnapshot.forEach(function(doc) {
                    json_all[doc.id] = doc.data()
                });
                gabung_data('car', json_all);
            });
    }

    var json_travel = [];
    var json_request = [];
    var json_users = [];
    var json_car = [];
    var kosong = 0;

    function gabung_data(nama_var, data) {
        if (nama_var == 'travel') {
            json_travel = data;
        } else if (nama_var == 'request') {
            json_request = data;
            if (Object.keys(json_request).length == 0) {
                kosong = 1;
            } else {
                kosong = 0;
            }
        } else if (nama_var == 'users') {
            json_users = data;
        } else if (nama_var == 'car') {
            json_car = data;
        }
        if ((Object.keys(json_travel).length > 0 || kosong == 1) && Object.keys(json_request).length > 0 && Object.keys(json_users).length > 0) {
            var json_onprogress_order = [];
            var json_request_key = Object.keys(json_request);
            json_request_key.forEach(function(key) {
                var date_arr = json_request[key].Tanggal_Berangkat.split('-');
                var action = `<a href="#" class="text-gray-600 block py-1 px-3" onclick="openDropdown(event,'table-light-1-dropdown')">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </a>
                                        <div class="hidden bg-white text-base z-50 float-left py-2 list-none text-left rounded shadow-lg min-w-48" id="table-light-1-dropdown">
                                            <a href="#" onclick='open_detail(this)' data-key='` + key + `' class="text-sm py-2 px-4 font-normal block w-full whitespace-no-wrap bg-transparent text-gray-800">Detail</a>
                                        </div>`;
                if (json_request[key].Status == "Approve" || json_request[key].Status == "Pending") {
                    var action = `<a href="#" class="text-gray-600 block py-1 px-3" onclick="openDropdown(event,'table-light-1-dropdown')">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </a>
                                        <div class="hidden bg-white text-base z-50 float-left py-2 list-none text-left rounded shadow-lg min-w-48" id="table-light-1-dropdown">
                                            <a href="#" onclick='open_detail(this)' data-key='` + key + `' class="text-sm py-2 px-4 font-normal block w-full whitespace-no-wrap bg-transparent text-gray-800">Detail</a>
                                            <a href="#!" onclick="cancel_request(this)" data-key="` + key + `" class="text-sm py-2 px-4 font-normal block w-full whitespace-no-wrap bg-transparent text-gray-800">Delete</a>
                                        </div>`;
                }
                var json_arr = [json_request[key].Nama || "", json_request[key].Departemen || "", json_request[key].Proyek || "", json_request[key].Perjalanan || "", json_request[key].Alamat_Asal || "", json_request[key].Alamat_Tujuan || "", date_arr[2] + "-" + date_arr[1] + "-" + date_arr[0] || "", json_request[key].Status || "", action];
                json_onprogress_order.push(json_arr);
            });
            $('.datatables').DataTable().clear().destroy();
            $('.datatables').DataTable({
                    responsive: true,
                    data: json_onprogress_order,
                    order: [
                        [6, "desc"]
                    ],
                    dom: 'Bfrtip',
                    buttons: [
                        'excelHtml5',
                        'csvHtml5',
                    ]
                }).columns.adjust()
                .responsive.recalc().draw();
            $('#loading_firebase').hide();
        }
    }

    function open_detail(btn) {
        var key = $(btn).attr("data-key");
        $("label[name=Nama]").text(json_request[key].Nama);
        $("label[name=Perjalanan]").text(json_request[key].Perjalanan);
        $("label[name=Departemen]").text(json_request[key].Departemen);
        $("label[name=Proyek]").text(json_request[key].Proyek);
        $("label[name=Alamat_Asal]").text(json_request[key].Alamat_Asal);
        $("label[name=Alamat_Tujuan]").text(json_request[key].Alamat_Tujuan);
        var date_arr = json_request[key].Tanggal_Berangkat.split('-');
        $("label[name=Tanggal_Berangkat]").text(date_arr[2] + "-" + date_arr[1] + "-" + date_arr[0]);
        $("label[name=Status]").text(json_request[key].Status);
        var table_travel = "";
        var no = 1;
        var tr = "";
        console.log(json_car);
        var json_travel_key = Object.keys(json_travel);
        json_travel_key.forEach(function(travel_key) {
            console.log(key + " " + json_travel[travel_key].Request_id);
            if (key == json_travel[travel_key].Request_id) {
                tr += "<tr>" +
                    "<td>" + no + "</td>" +
                    "<td>" + json_travel[travel_key].Mulai + "</td>" +
                    "<td>" + json_travel[travel_key].Berhenti + "</td>" +
                    "<td>" + json_travel[travel_key].Waktu_Perjalanan + "</td>" +
                    "<td>" + json_users[json_request[json_travel[travel_key].Request_id].driverId].Nama + "</td>" +
                    "<td>" + (json_travel[travel_key].hasOwnProperty('CarId') ? json_car[json_travel[travel_key].CarId].no_polisi : "") + "</td>" +
                    "</tr>";
                no++;
            }
        });
        console.log(tr);
        $(".table-detail tbody").html(tr);
        $('.modal_detail').modal({
            "show": true
        })
    }

    function cancel_request(btn) {
        Swal.fire({
            title: 'Are you sure to <b class="text-danger">&nbsp;Cancel&nbsp;</b> this?',
            text: "You won't be able to revert this!",
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, Cancel it!'
        }).then((result) => {
            if (result.value) {
                sweetalert('loading', 'Please Wait...');
                var key = $(btn).attr("data-key");
                var driverId_save = "";
                var docRef = db.collection('Request').doc(key);
                docRef.get().then(function(doc) {
                    if (doc.exists) {
                        var data = doc.data();
                        console.log(data.driverId);
                        driverId_save = data.driverId;
                        var removeCapital = docRef.update({
                                verId: firebase.firestore.FieldValue.delete(),
                                driverId: firebase.firestore.FieldValue.delete(),
                                Status: "Cancel"
                            }).then(function() {
                                data_driver = {
                                    Status: "Available",
                                }
                                var docRef_driver = db.collection("Users").doc(driverId_save);
                                docRef_driver.update(data_driver)
                                    .then(function() {
                                        sweetalert("success", "Request successfully canceled!");
                                    })
                                    .catch(function(error) {
                                        sweetalert("error", "Error updating request: " + error);
                                    });
                            })
                            .catch(function(error) {
                                sweetalert("error", "Error updating document: " + error);
                            });
                    } else {
                        window.location = '<?php echo base_url() ?>order/history_order_list';
                    }
                }).catch(function(error) {
                    sweetalert("error", "Error getting document:" + error);
                })
            }
        })
    }
</script>